#summary Инструкция по установке в геймпад флешки с XBMC
#labels Featured,Phase-Deploy
=Апгрейд Пикселькита с помощью флешки и XBMC=
Итак, для того, чтобы ваш старый-новый геймпад стал совсем похож на тот, что вы видели на видео, в него помимо пикселькита нужно поместить ещё две важные вещи: обычную USB-флешку и компактный USB-хаб для того чтобы все это работало вместе через один кабель. Из ингредиентов нам остро понадобятся:
  # Компактная USB-флешка на 1Гб и более (чем быстрее, тем лучше)
  # Компактный USB2.0-хаб на 3-4 порта (к этой детали особые требования -- читайте ниже)
  # Бесплатная программа-медиацентр [http://xbmc.org/download/ XBMC] (вместо пунктов 3, 4 и 5 рекомендую установить нашу готовую сборку этих компонентов, которая настроена и позволяет работать им в portable-режиме)
  # Плагин [http://code.google.com/p/xbmc-launcher/ Launcher] для XBMC
  # Бесплатная программа для работы с профилями управления [http://www.eventghost.org/ EventGhost]

Из инструментов понадобится дремель для резки корпуса, пистолет с термоклеем или эпоксидка. Бокорезы, напильники и скальпели в ассортименте.
==Хаб и флешка==
Вообще умельцы могут упрекнуть меня в дилетантском подходе. Сказать что негоже расковыривать годные хабы и флешки, когда можно собрать собственные на той же плате. Я же решил, что будет и проще и, скорее всего, дешевле воспользоваться готовыми компонентами. И уж точно эти компоненты будет проще найти, чем память и всю электронную обвязку к ней да ещё и в пригодных корпусах. Так или иначе, решение показалось мне очевидным -- подцепить на один slave-вывод хаба Пикселькит, на второй флешку, а master отправить в компьютер. Кстати, дополнительное питание при этом хабу не потребуется.

Флешка подойдёт практически любая. Я использовал Kingston и Kingmaх в различных корпусах на 4Гб (около 350 рублей). Разумеется, чем выше скорость, тем быстрее будет работать и оболочка. Всё, что нужно сделать с флешкой -- аккуратно разбить корпус и снять металлический USB-коннектор, предварительно запомнив какие контактные площадки каким выводам соответствовали. Всё, флешка готова к установке в геймпад.
<div><a href="http://picasaweb.google.ru/lh/photo/K3Kwn7Vw2_j4I2qcs489QQ?feat=embedwebsite"><img src="http://lh5.ggpht.com/_pcbSxfY74TA/TDRWo5b522I/AAAAAAAAAlk/92wkiHjSy9U/s400/21-Flash_hub.jpg" /></a></div>

С хабом дела обстоят сложнее. Самая большая проблема -- это размер. Хаб должен быть действительно(!) компактным. У него должно быть 4 или 3 вывода (меньше я не встречал, хотя для наших целей хватит и двух). На нём не должно быть высоких конденсаторов, которые производители так любят устанавливать в большинство OEM-хабов. Я использовал хаб [http://www.gembird.ru/accessories/catalog/equipment.php?id=14962&firm=undefined Gembird UHB-CT01], но он дорогой (те же 350 рублей) и в итоге остановился на 5ти долларовом noname-хабе с [http://www.dealextreme.com/details.dx/sku.34421 dealxtreame.com] (на фото). У всех встреченных мной хабов есть ещё один общий недостаток -- они нагреваются. В итоге я прилепил к главному чипу алюминиевую пластину-радиатор на термопроводяший клей (не путать с термоклеем из пистолета). В противном случае хаб нагревал сам геймпад изнутри -- не смертельные, но не очень приятные ощущения.

Раскалываем корпус хаба и отрезаем всё лишнее, оставляем только плату. На плате не должно остаться никаких деталей, без которых он может работать и которые могли бы помешать при его установке в геймпад. Провода, разъёмы и пр. выпаивайте/выкусывайте предварительно запомнив какие контактные площадки каким выводам соответствуют. Кстати, в некотороых случаях, если плата хаба ну никак не влезает в корпус, можно поробовать вырезать некоторые куски прямо из неё. Только предварительно убедитесь в том, что все компоненты из этих областей обслуживают ненужные вам slave-выводы (как вы помните, нам необходимо всего 2 порта, а не 4). Хаб (вернее, то, что от него осталось) готов.
==Сборка геймпада (окончательная)==
Всё, что вы разломали выше нужно уместить в корпус геймпада, в котором итак почти нет места. Практически все геймпады, которые я переделывал позволяли разместить копоненты как-то так:

  * Справа Пикселькит (под action-кнопками)
  * Слева хаб (под крестовиной)
  * Флешка по центру

Сложно размещать компоненты в 6ти кнопочном геймпаде от Sega. В нём совсем мало места. Если у вас получится упаковать в него и Пикселькит и хаб и флешку не забудьте прислать мне фотографию, я добавлю её в общий альбом.
<div><a href="http://picasaweb.google.ru/lh/photo/DSliH0Cr_0wdT2si0mIe-Q?feat=embedwebsite"><img src="http://lh6.ggpht.com/_pcbSxfY74TA/TDRWoM1ZvOI/AAAAAAAAAlc/mYd6oNF_W2s/s400/08-Cut.jpg" /></a></div>

Предварительно прикинув как всё это будет размещаться в контроллере, нужно проанализировать какие части крышки корпуса придётся вырезать, как и ранее при установке Пикселькита. После серии примерок будет нужно спаять все три компонента вместе. Тут, я думаю, никакие объяснения и схемы не нужны -- всё подключается так, если бы вы воткнули в хаб флешку с одной стороны, ваш геймпад с другой и подключили бы его (хаб) к компьютеру. Разумеется все провода нужно припаивать строго к соответствующим им площадкам (я же не зря просил вас запоминать как были расположены коннекторы на хабе и флешке). В крайнем случае вы всегда можете подсмотреть в Википедии, [http://ru.wikipedia.org/wiki/USB разводку разъёма] или протестировать её прозвонкой.

Как я писа выше, не оставляйте лишних соединительных проводов в геймпаде. При запаковке они обязательно залезут под какой-нибудь шуруп и переломятся. Лучше всего использовать заранее соединённые проводки от старых DMA-шлейфов. Они тонкие и не будут виться как лапша.
<div><a href="http://picasaweb.google.ru/lh/photo/OwIMz-zJg6X7OthRP6CbpQ?feat=embedwebsite"><img src="http://lh4.ggpht.com/_pcbSxfY74TA/TDRWxg_FqXI/AAAAAAAAAlo/Gka-WjNDDvM/s400/23-Full_final.jpg" /></a></div>

Всё. Закрепляйте внутренности термоклеем, по возможности изолируйте провода и контактные площадки (но без фанатизма) и собирайте геймпад, проверяя нет ли где деформаций корпуса. Подключайте к компьютеру и убеждайтесь, что контроллер и флешка исправно работают. Теперь можно выдохнуть -- железная часть закончена.
==XBMC==
В качестве фронтенда для запуска старых игр прямо с геймпада мы будем использовать бесплатный опенсорсовый медиа-центр. XBox Media Center (XBMC) изначально разрабатывался как оболочка первой версии приставки XBox для просмотра фильмов и прослушивания музыки. Сейчас это довольно мощный инструмент, который используется для построения полноценных HTPC и имеет огромное сообщество разработчиков плагинов, скриптов и пр.

Для того чтобы начать использовать XBMC в качестве менеджера игрушек и лаунчера для эмуляторов нужно скачать нашу сборку, которая сэкономит вам время. Если вы из тех кто любит всё делать самостоятельно и хотя бы номинально знаком с языком программирования Python,  можете скачать свежий [http://xbmc.org/download/ дистрибутив] с сайта производителя и [http://wiki.xbmc.org/index.php?title=XBMC_Online_Manual настроить] всё так, как душе угодно.

Итак, скачиваем нашу сборку, распаковываем её содержимое прямо в корень вашего геймпада-флешки (именно в корень, иначе придётся переписать start.bat). Запускаем start.bat, предварительно отключив разные антивирусы и UAC (временная мера), если таковые имеются. Не то чтобы мы распространяли вирусы, просто скрипт запустит сразу два приложения, а большинство средств защиты считают это вопиющей наглостью и закрывают на клюшку всё до чего смогут добраться). Если при старте обнаружите ошибку XBMC, то с 99% вероятностью это будет означать, что вам нужно обновить DirectX. Его мы не включаем в сборку, но рекомендуем держать на флешке на всякий случай (весит около 12 Мб).
<div><a href="http://picasaweb.google.ru/lh/photo/Xnv4WRxUwHddb6hpttAEjA?feat=embedwebsite"><img src="http://lh3.ggpht.com/_pcbSxfY74TA/TDRWxmlckVI/AAAAAAAAAls/QcVtdMvv8iw/s400/24-XBMC_main.jpg" /></a></div>

В теории, после старта всё должно без проблем заработать (если только у вас в системе одновременно не подключено несколько геймпадов с Пикселькитом). Для медленных машин я бы посоветовал выждать короткий отрезок времени, после загрузки XBMC для того чтобы успел включиться EventGhost и геймпад начал корректно вести себя внутри меню. Обычно это происходит одновременно с установкой XBMC соединения с интернетом (в правом верхнем углу появляется виджет с погодой, а в нижней строке начинает бегать RSS).

Полноценный медиацентр в вашем распоряжении. Можно [http://wiki.xbmc.org/?title=HOW-TO_install_and_use_plugins_in_XBMC устанавливать плагины], [http://wiki.xbmc.org/index.php?title=HOW-TO_install_and_use_scripts_in_XBMC скрипты]. Слушать музыку, смотреть фильмы, трейлеры, потоковое видео, смотреть фотки с BigPicture и пр.
==Launcher==
Сердцем XBMC для эмуляторов старых консолей является [http://code.google.com/p/xbmc-launcher/ плагин Launcher], который, [http://trac.xbmc.org/ticket/6324 к сожалению], уже не поддерживается его автором. Тем не менее, мы собрали все наработки и багфиксы, которые были выпущены сторонними разработчиками и внесли в плагин некоторые собственные изменения (самое главное -- это возможность работать в portable-режиме, без привязки к конкретному компьютеру).

Основная задача лаунчера -- запуск файлов (т.н. “ромов”) с использованием заранее настроенных для этого приложений (эмуляторов). Так же с его помощью можно выстраивать иерархию файлов, устанавливать превьюшки для эмуляторов и игр прямо из интерфейса XBMC.

По понятной причине мы не можем включить игры в нашу сборку, поэтому вам придётся скачать их самостоятельно и затем поместить в папки {{{\Roms}}} соответствующих эмуляторов. Сборка содержит несколько эмуляторов. Вот их список:
  * *Fusion36* (Sega Mega Drive2 / Genesis / Master System) открывает smd, srm и пр.
  * *Nestopia* (NES, она же Famicom, а так же Dendy) открывает nes, unf, fds и пр.
  * *Project 64* (Nintendo 64) открывает z64 и пр.
  * *Snes9x* (SNES она же Super Famicom) открывает smc, sfc, fig и пр.
  * *VBA-M* (GameBoy / Advance / Color) открывает gb, gba, gbc и пр.
<div><a href="http://picasaweb.google.ru/lh/photo/n-y3dbSBZ3Fv3VYbEJ6tqw?feat=embedwebsite"><img src="http://lh5.ggpht.com/_pcbSxfY74TA/TDRWx1LViTI/AAAAAAAAAlw/5nN0A5EJ7go/s400/25-XBMC_Emu_context.jpg" /></a></div>

Для того чтобы добавить новые эмуляторы нужно, находясь внутри директории лаунчера, вызвать контекстное меню и выбрать пункт “add new launcher”. Дальше отвечайте на все вопросы мастера. При указании путей размещения, важно выбирать “Q Drive” -- это виртуальный алиас для XBMC по которому он определяет свою корневую директорию для работы в portable-режиме. При добавлении эмуляторов можно обойтись и без GUI, сконфигурировав соответствующий файл плагина:

{{{XBMC\userdata\plugin_data\programs\Launcher\launchers.xml}}}

После того, как вы добавили игры в соответствующие папки нужно рассказать об этом плагину. Для того, чтобы он их проиндексировал, достаточно выбрать пункт “import files from path” в контекстном меню конкретного эмулятора. Установка иконок-превьюшек так же производится через контекстное меню или вручную через файл настроек (сами картинки хранятся в папке {{{XBMC\userdata\UserData\Thumbnails\Programs}}}). Кстати, для первого варианта вам понадобится подключение к интернету.
<div><a href="http://picasaweb.google.ru/lh/photo/1XUVpZk8apQ1Sm3ooKOrKA?feat=embedwebsite"><img src="http://lh4.ggpht.com/_pcbSxfY74TA/TDRWx0vYPjI/AAAAAAAAAl0/PWFUuOCg64Q/s400/26-XBMC_Roms.jpg" /></a></div>

Подробнее ознакомиться с возможностями плагина можно на его [http://code.google.com/p/xbmc-launcher/ странице], либо в [http://forum.xbmc.org/showthread.php?t=34834 одном] из [http://forum.xbmc.org/showthread.php?t=35739 эпических] [http://forum.xbmc.org/showthread.php?t=72441 тредов] форума XBMC.
==EventGhost==
Как известно, ничто никогда не идёт по плану. Вот и мои ожидания по поводу беспрепятственной работы XBMC с пикселькитом разбились вдребезги после попыток настроить d-pad (крестовину) для навигации по основному меню. Строго говоря, заработал он без проблем, вот только XBMC упорно считал его аналоговым стиком, а поэтому единичное нажатие распознавалось, как длительное удерживание. Из-за этого после малейшего касания крестовины меню начинало лихорадочно крутиться.

На помощь пришла бесплатная программа [http://www.eventghost.org/ EventGhost], призванная автоматизировать работу операционной системы и выступающая в роли гибкого триггерного лаунчера. С её помощью у вас появится возможность не только комфортно управлять геймпадом внутри XBMC, но и управлять с его помощью эмуляторами. Т.е. фактически вы сможете запускать игры из XBMC геймпадом и возвращаться в XBMC из эмуляторов (а в некоторых случаях даже управляться с их меню) c его же помощью. На видео видно, как я закрываю эмуляторы путём удерживания левого шифта на протяжении 4х секунд. Клавиатура и мышь вам больше совсем не понадобятся.

{{{Start.bat}}} настроен таким образом, что одновременно со стартом XBMC запускает и EventGhost с файлом настроек ({{{XBMC\EventGhost\NES_XBMC.xml}}}). В свою очередь EventGhost при завершении процесса XBMC убивает сам себя (довольно негуманным способом -- решаем проблему) делая вид, будто его и не было.

Если вы используете с XBMC геймпад от XBox 360, или похожий продвинутый контроллер, то вам, вероятнее всего, понадобиться сконфигурировать его с помощью файла из директории {{{XBMC\userdata\keymaps\}}} описание которого можно найти в [http://wiki.xbmc.org/index.php?title=Keymap.xml вики XBMC]. В эту же директорию помещаются и файлы с настройками геймпадов с Пикселькитом внутри.  Если вам нужно поменять местами кнопки, или в разных экранах XBMC использовать разный маппинг, то смело исправляйте имеющийся файл {{{Joystick.SNES.xml}}}.

За работой геймпада вне пределов XBMC отвечает только(!) EventGhost. Рассмотрим простой пример, поняв который вы без труда сможете добавлять другие эмуляторы и программы в XBMC таким образом, чтобы они управлялись с геймпада.
<div><a href="http://picasaweb.google.ru/lh/photo/Gmv36rClo3JWrNnsa7feGQ?feat=embedwebsite"><img src="http://lh3.ggpht.com/_pcbSxfY74TA/TDRWyL3OULI/AAAAAAAAAl4/DzyycFUNCJM/s400/27-EventGhost.jpg" /></a></div>

EventGhost отслеживает события системы, которые вы можете видеть в логе слева. К любому такому событию можно привязать действие. Работа геймпада с меню эмулятора начинается сразу, как только этот эмулятор (для примера возьмём Snes9x) запускается, на окно переводится фокус, а XBMC сворачивается в трей. Именно по этому событию EventGhost запускает профиль для соответствующего эмулятора (2). Сразу после этого отключается профиль XBMC (нам ведь не нужно чтобы геймпад работал одновременно в двух приложениях). Внутри профиля Snes9x (1) всё предельно просто. EventGhost следит всего за двумя действиями:

  # Удерживание левого шифта геймпада в течение 4х секунд
  # Удерживание правого шифта в течение 4х секунд.

Отловив первое условие, EventGhost эмулирует нажатие на клавиатуре клавиш Esc, Alt, Down, чем включает меню эмулятора Snes9x и разворачивает в нём первую вкладку. Дальше у пользователя появляется возможность осуществлять навигацию по всему меню с помошью крестовины геймпада. Отловив второе условие, EventGhost эмулирует нажатие кнопки Enter, чем подтверждает выбор пользователя. Ну и после выхода из эмулятора срабатывает триггер, который выключает профиль Snes9x и вновь включает профиль XBMC.

В нашем варианте EventGhost (как и {{{Joystick.SNES.xml}}}) настроен на работу с геймпадом от SNES и обновлённой прошивкой. Если вы хотите использовать другие геймпады -- просто переиначте кнопки, как вам нужно. В качестве ID кнопки используйте данные из окна настройки контроллера, которое открывается из панели управления Windows.

EventGhost -- очень гибкий инструмент и если уделить ему чуть больше внимания, то не составит труда управлять с вашего геймпада, например, браузером (который можно прикрутить в XBMC к лаунчеру) или чем-то посложнее.

Не забывайте, что для игр геймпад нужно настраивать в самом эмуляторе (лишь при первом подключении). Это простая процедура, займёт не больше 10 секунд -- нужно зайти в окно настроек и по очереди нажать на геймпаде кнопки, соответствующие нужным действиям.

Похоже это всё, друзья. В случае, если у вас что-то не работает таким образом, который я тут описал, могу посоветовать лишь обратиться к официальному хелпу. А если вам кажется будто что-то не работает именно из-за моих вмешательств, то шлите почту в ящик atarity на домене gmail.com -- попробуем разобраться вместе. В будущем я постараюсь сократить туториал, а такие разделы, как прошивка микроконтроллера и настройка XBMC вынести в отдельный блог. Возможно у анс получится исключить из сборки EventGhost оставив лишь его конфигурационный файл. И да, не забывайте слать нам фотки того, что у вас получается и делиться со всеми своим опытом.

All your base are belong to us! Пиу-пиу.